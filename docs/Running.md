# Run Instructions

## Components Overview

1) **Watchdogd**: `watchdogd` can be considered as the watchdog backend and
    is in charge of collecting and capturing information. `watchdogd` is
    designed to be run as a `systemctl` service with root-level access
    permissions. However, it can be run as a standalone executable.

2) **Watchdog**: `watchdog` is a simple command-line tool that serves as
    the frontend and user interface to the Watchdog software. It can be
    used to add directories to the watch list, to list the directories
    previously added to the watch list, and to consume file system events
    that are collected by the watchdog daemon.

## Setting Up the Named Pipes

The two components mentioned above are designed to communicate with
eachother through two dedicated named pipes. As explained in the
[Design] document, this design is far from ideal, since it could
lead to unintended behaviors when multiple `watchdog` instances are
running at the same time.

Practically, the current design requires setting up the named pipes for use
by the two applications. Ideally, the two applications should be able to
handle creating these pipes when they are missing but they do not do so at
the moment.

Run the following commands to create the pipes:

```bash
mkdir -p /tmp/watchdog
mkfifo /tmp/watchdog/sin
mkfifo /tmp/watchdog/sout
```

### Testing the Named Pipes

Preferrably you should test these pipes by manually using them for the first
time. It is easy to do so, using two terminals:

* Start reading from the pipe from terminal 1:

    ```bash
    cat /tmp/watchdog/sin
    ```

* Start writing to the pipe from terminal 2:

    ```bash
    $ cat > /tmp/watchdog/sin
    hello
    ^C
    ```

* You can expect to see that your message `hello` is shown in terminal 1.

## Running the Service

Now that we setup the Named Pipes, we can start running Watchdog daemon.

```bash
./local/dist/watchdogd
```

You will notice that the application does not write anything to the standard
output yet. This is expected. The daemon is running but we have not added
any directory to be monitored yet.

## Using Command Line Tool

We can use the watchdog command-line tool to interact with the watchdog daemon.
Launch a separate terminal and run the following command to see a list of
command line options supported by the tool:

```txt
$ ./local/dist/bin/watchdog

Command Line Tool for Monitoring Filesystem Events
Usage:
  ./local/dist/bin/watchdog [OPTION...] [optional args]

  -a, --add arg  add a given directory to the watch-list
  -c, --clear    clear the watch-list
  -l, --list     list directories on the watch-list
  -m, --monitor  prints recent filesystem events occuring in any directory on
                 the watch-list
      --help     prints all supported command line options
```

We can start by asking the daemon to monitor a given directory.

```txt
$ ./local/dist/bin/watchdog -a .

added directory /home/pejman/watchdog to the watch-list
```

Now let us see what processes are using this directory or any of its files:

```txt
$ ./local/dist/bin/watchdog -m

   1 process bash (pid: 81378) accessed "/home/pejman/watchdog"
   2 process bash (pid: 81473) accessed "/home/pejman/watchdog"
   3 process cpptools (pid: 81502) accessed "/home/pejman/watchdog"
   4 process node (pid: 82492) accessed "/home/pejman/watchdog"
   5 process bash (pid: 82858) accessed "/home/pejman/watchdog"
   6 process watchdogd (pid: 120175) accessed "/home/pejman/watchdog"
   7 process watchdogd (pid: 120175) accessed "/home/pejman/watchdog/local/ditbin/watchdogd""
   8 process sh (pid: 120426) accessed "/home/pejman/watchdog"
   9 process lsof (pid: 120427) accessed "/home/pejman/watchdog"
  10 process lsof (pid: 120428) accessed "/home/pejman/watchdog"
```

Note that this command returns as soon as we consume all filesystem events
that were generated by the daemon so far. We can run the same command again
to read any new events captured by the daemon since last time.

The Watchdog daemon continues to capture events in all directories under watch, as long as it is running. Ideally, these events should be persistent
somewhere but that is not the case at the moment. The events are captured
in memory on a simple queue, prone to overflow.

Let us now add two more directories to the list of directories under watch:

```txt
$ ./local/dist/bin/watchdog -a ~/example ~/dotfiles

added directory /home/pejman/example to the watch-list
added directory /home/pejman/dotfiles to the watch-list
```

We can always query the list of directories under watch:

```txt
$ ./local/dist/bin/watchdog -l

Watchdog is currently monitoring the following files:
   1 "/home/pejman/examplea"
   2 "/home/pejman/dotfiles"
   3 "/home/pejman/example"
```

And when we are no longer interested in monitoring these directories, we
can ask watchdog to clear this list:

```txt
$ ./local/dist/bin/watchdog -c

cleared the list of directories under watch
```

## User Experience Defects

* Currently, there is no way to remove one particular directory from the
  watch list, while keeping other directories on the list. We have not
  implemented how to handle the case when a directory is added and later
  one of its subdirectories are removed.

* In the output of certain commands such as `list` and `monitor`, you may
  see `l,OK` and `m,OK` as the last entry in the list. This is a known defect
  that we know how to fix but are deferring making any changes to the code for
  the time being.

Other known design issues are covered in the [Design] document.

[Design]: ./Design.md